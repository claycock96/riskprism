{"summary":{"total_changes":5,"creates":4,"updates":0,"deletes":1,"replaces":0,"terraform_version":"1.5.0"},"diff_skeleton":[{"resource_type":"aws_security_group","action":"create","changed_paths":["description","egress","ingress","name","tags","vpc_id"],"attribute_diffs":[{"path":"description","before":null,"after":"Security group for web servers"},{"path":"egress","before":null,"after":[{"from_port":0,"to_port":0,"protocol":"-1","cidr_blocks":["0.0.0.0/0"]}]},{"path":"ingress","before":null,"after":[{"from_port":22,"to_port":22,"protocol":"tcp","cidr_blocks":["0.0.0.0/0"],"description":"SSH access"},{"from_port":80,"to_port":80,"protocol":"tcp","cidr_blocks":["0.0.0.0/0"],"description":"HTTP access"},{"from_port":443,"to_port":443,"protocol":"tcp","cidr_blocks":["0.0.0.0/0"],"description":"HTTPS access"}]},{"path":"name","before":null,"after":"web-sg"},{"path":"tags","before":null,"after":{"Name":"web-sg","Environment":"production"}},{"path":"vpc_id","before":null,"after":"vpc-12345678"}],"resource_id_hash":"res_22acec59da","resource_address":"aws_security_group.web"},{"resource_type":"aws_db_instance","action":"create","changed_paths":["allocated_storage","backup_retention_period","db_name","engine","engine_version","instance_class","multi_az","publicly_accessible","storage_encrypted","tags","username"],"attribute_diffs":[{"path":"allocated_storage","before":null,"after":100},{"path":"backup_retention_period","before":null,"after":7},{"path":"db_name","before":null,"after":"myapp"},{"path":"engine","before":null,"after":"postgres"},{"path":"engine_version","before":null,"after":"14.7"},{"path":"instance_class","before":null,"after":"db.t3.medium"},{"path":"multi_az","before":null,"after":false},{"path":"publicly_accessible","before":null,"after":true},{"path":"storage_encrypted","before":null,"after":false},{"path":"tags","before":null,"after":{"Name":"main-db","Environment":"production"}},{"path":"username","before":null,"after":"admin"}],"resource_id_hash":"res_9468970500","resource_address":"aws_db_instance.main"},{"resource_type":"aws_s3_bucket","action":"create","changed_paths":["acl","bucket","tags"],"attribute_diffs":[{"path":"acl","before":null,"after":"public-read"},{"path":"bucket","before":null,"after":"myapp-data-bucket"},{"path":"tags","before":null,"after":{"Name":"data-bucket","Environment":"production"}}],"resource_id_hash":"res_06e953a89c","resource_address":"aws_s3_bucket.data"},{"resource_type":"aws_iam_role_policy","action":"create","changed_paths":["name","policy","role"],"attribute_diffs":[{"path":"name","before":null,"after":"lambda-exec-policy"},{"path":"policy","before":null,"after":"{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\",\"Action\":\"*\",\"Resource\":\"*\"}]}"},{"path":"role","before":null,"after":"lambda-exec-role"}],"resource_id_hash":"res_3589369b5b","resource_address":"aws_iam_role_policy.lambda_exec"},{"resource_type":"aws_cloudtrail","action":"delete","changed_paths":["enable_logging","is_multi_region_trail","name","s3_bucket_name"],"attribute_diffs":[{"path":"enable_logging","before":true,"after":null},{"path":"is_multi_region_trail","before":true,"after":null},{"path":"name","before":"main-trail","after":null},{"path":"s3_bucket_name","before":"cloudtrail-logs","after":null}],"resource_id_hash":"res_a02da504df","resource_address":"aws_cloudtrail.main"}],"risk_findings":[{"risk_id":"SG-OPEN-INGRESS","title":"Security group allows public internet ingress","severity":"critical","resource_type":"aws_security_group","resource_ref":"res_22acec59da","evidence":{"public_cidr":true,"exposed_ports":[22,80,443],"critical_port_exposed":true},"recommendation":"Restrict CIDR blocks to known IP ranges. For SSH/RDP, use AWS Systems Manager Session Manager or a bastion host. For databases, ensure they are in private subnets with security groups allowing only application tier access.","suggested_fix":"ingress {\n  from_port   = 443\n  to_port     = 443\n  protocol    = \"tcp\"\n  cidr_blocks = [\"10.0.0.0/16\"] # Restricted range\n}","changed_paths":null},{"risk_id":"RDS-PUBLICLY-ACCESSIBLE","title":"RDS instance is publicly accessible","severity":"critical","resource_type":"aws_db_instance","resource_ref":"res_9468970500","evidence":{"publicly_accessible":true},"recommendation":"Set publicly_accessible to false. Place RDS in private subnets. Use VPC security groups to restrict access to application tier only.","suggested_fix":"publicly_accessible = false","changed_paths":null},{"risk_id":"S3-PUBLIC-ACL-OR-POLICY","title":"S3 bucket ACL allows public access","severity":"critical","resource_type":"aws_s3_bucket","resource_ref":"res_06e953a89c","evidence":{"public_acl":"public-read","public_write":false},"recommendation":"Change ACL to 'private'. Enable S3 Block Public Access. Use bucket policies with specific principals for controlled sharing.","suggested_fix":"acl = \"private\"","changed_paths":null},{"risk_id":"IAM-ADMIN-WILDCARD","title":"IAM policy contains wildcard permissions","severity":"critical","resource_type":"aws_iam_role_policy","resource_ref":"res_3589369b5b","evidence":{"action_wildcard":true,"admin_risk":true},"recommendation":"Scope IAM actions and resources to least privilege. Avoid Action: '*' and Resource: '*'. Use separate break-glass admin roles with MFA and monitoring.","suggested_fix":"statement {\n  actions   = [\"ec2:Describe*\", \"s3:ListBucket\"]\n  resources = [\"*\"]\n  # Prefer specific resource ARNs where possible\n}","changed_paths":null},{"risk_id":"CT-LOGGING-DISABLED","title":"CloudTrail logging removed","severity":"critical","resource_type":"aws_cloudtrail","resource_ref":"res_a02da504df","evidence":{"cloudtrail_removed":true},"recommendation":"Maintain CloudTrail logging for audit and compliance. Use organization trails for multi-account coverage.","suggested_fix":"# Do not delete aws_cloudtrail resources in production","changed_paths":null},{"risk_id":"RDS-ENCRYPTION-OFF","title":"RDS instance storage encryption disabled","severity":"high","resource_type":"aws_db_instance","resource_ref":"res_9468970500","evidence":{"encryption_disabled":true},"recommendation":"Enable storage_encrypted. Note: existing instances require snapshot, restore to new encrypted instance. Plan for maintenance window.","suggested_fix":"storage_encrypted = true","changed_paths":null}],"explanation":{"executive_summary":["This plan creates 4 new resources and deletes 1 existing resource, with multiple CRITICAL security vulnerabilities that require immediate attention before deployment","A production database is being exposed to the public internet without encryption, creating significant data breach risk","An IAM policy grants unrestricted wildcard permissions (Action: *, Resource: *), violating least privilege principles","CloudTrail logging is being removed, eliminating audit trails required for security monitoring and compliance","Public access is being granted through both security group rules (SSH on port 22) and S3 bucket ACLs"],"plain_english_changes":"**Creates (4 resources):**\n\n- **1 Security Group** (`aws_security_group`): Creating a new security group for web servers with ingress rules for SSH (22), HTTP (80), and HTTPS (443), plus unrestricted egress. Tagged for production environment.\n\n- **1 RDS Database Instance** (`aws_db_instance`): Provisioning a PostgreSQL 14.7 database (db.t3.medium) with 100GB storage, 7-day backup retention, single-AZ deployment. Tagged for production environment.\n\n- **1 S3 Bucket** (`aws_s3_bucket`): Creating a new S3 bucket with ACL configuration. Tagged for production environment.\n\n- **1 IAM Role Policy** (`aws_iam_role_policy`): Attaching a new inline policy to a Lambda execution role with permission statements.\n\n**Deletes (1 resource):**\n\n- **1 CloudTrail** (`aws_cloudtrail`): Removing an existing multi-region CloudTrail configuration that was actively logging to an S3 bucket.","top_risks_explained":"### Security group allows public internet ingress\n\n**Risk**: The security group being created allows inbound traffic from 0.0.0.0/0 (the entire internet) on ports 22 (SSH), 80 (HTTP), and 443 (HTTPS).\n\n**Why This Matters**: Exposing SSH to the public internet is a critical security vulnerability. Port 22 is constantly scanned and targeted by automated attacks attempting credential brute-forcing, exploitation of SSH vulnerabilities, and unauthorized access. Even with strong authentication, this creates an unnecessary attack surface. For production environments, administrative access should never be directly exposed to the internet.\n\n**Attack Scenario**: An attacker runs automated port scans identifying your SSH service on port 22. They launch a credential stuffing attack using leaked password databases or attempt to exploit known SSH vulnerabilities. If successful, they gain shell access to your web servers, can pivot to internal resources, exfiltrate data, install malware, or use your infrastructure for cryptocurrency mining or launching attacks against other targets.\n\n---\n\n### RDS instance is publicly accessible\n\n**Risk**: The RDS database instance has `publicly_accessible` set to `true`, meaning it will receive a public IP address and can be reached from the internet.\n\n**Why This Matters**: Databases contain sensitive application data and should never be directly accessible from the internet. Even with security group restrictions, a publicly accessible database has a routable IP address that can be discovered and targeted. This violates defense-in-depth principles and significantly increases the blast radius if credentials are compromised through application vulnerabilities, phishing, or insider threats.\n\n**Attack Scenario**: An attacker discovers your RDS endpoint through DNS enumeration or leaked configuration files. They exploit a SQL injection vulnerability in your application to extract database credentials, or use credentials exposed in a public GitHub repository. With the database publicly accessible, they connect directly from anywhere in the world, bypassing application-layer controls, and exfiltrate customer data, financial records, or personally identifiable information (PII), leading to regulatory fines, lawsuits, and reputational damage.\n\n---\n\n### S3 bucket ACL allows public access\n\n**Risk**: The S3 bucket is being created with ACL set to `public-read`, allowing anyone on the internet to list and download objects in the bucket.\n\n**Why This Matters**: Public S3 buckets are a leading cause of data breaches. The `public-read` ACL grants unauthenticated read access to all objects, meaning sensitive data stored in this bucket is immediately exposed. This is particularly dangerous for a bucket tagged as production and named for application data. Automated scanners continuously search for publicly accessible S3 buckets.\n\n**Attack Scenario**: An attacker uses automated tools to enumerate S3 bucket names and discovers your publicly readable bucket. They download all contents, which may include customer data, API keys, database backups, or proprietary business information. This data is then sold on dark web forums, used for identity theft, or leveraged for targeted phishing campaigns against your customers. The breach becomes public, triggering GDPR/CCPA violations with fines up to 4% of annual revenue.\n\n---\n\n### IAM policy contains wildcard permissions\n\n**Risk**: The IAM role policy being created grants `Action: *` and `Resource: *`, providing unrestricted access to all AWS services and resources in the account.\n\n**Why This Matters**: This is effectively administrative access without the controls typically applied to admin roles. If the Lambda function using this role is compromised through code vulnerabilities, dependency exploits, or supply chain attacks, the attacker inherits full AWS account control. This violates the principle of least privilege and creates a single point of catastrophic failure.\n\n**Attack Scenario**: A developer introduces a vulnerable dependency in the Lambda function code that allows remote code execution. An attacker exploits this vulnerability and gains control of the Lambda execution environment. With the wildcard IAM permissions, they use the AWS SDK to create new admin users, disable CloudTrail logging, exfiltrate data from all S3 buckets, launch cryptocurrency mining instances across all regions, modify security groups to open backdoors, and establish persistence mechanisms. The blast radius is your entire AWS account.\n\n---\n\n### CloudTrail logging removed\n\n**Risk**: The plan deletes an existing CloudTrail configuration that was providing multi-region audit logging.\n\n**Why This Matters**: CloudTrail is your security camera system for AWS. It records all API calls, providing the audit trail necessary for security investigations, compliance requirements (SOC 2, PCI-DSS, HIPAA), and detecting unauthorized access. Removing CloudTrail eliminates your ability to detect breaches, investigate incidents, or prove compliance. This is often one of the first actions attackers take after compromising an account to hide their activities.\n\n**Attack Scenario**: After removing CloudTrail, an attacker compromises an IAM credential through phishing. They access your AWS account and begin exfiltrating data, creating backdoor access, and modifying resources. Without CloudTrail logs, your security team has no visibility into these actions. The breach continues undetected for months. When finally discovered through customer complaints, you have no forensic evidence to determine what was accessed, when the breach started, or how to fully remediate. Compliance auditors fail your certification, and you cannot provide required breach notifications with accurate scope.\n\n---\n\n### RDS instance storage encryption disabled\n\n**Risk**: The RDS database instance has `storage_encrypted` set to `false`, meaning data at rest is stored unencrypted.\n\n**Why This Matters**: Unencrypted database storage violates data protection best practices and compliance requirements. If the underlying storage is compromised, accessed by unauthorized AWS personnel, or if snapshots are accidentally exposed, the data is readable without additional decryption steps. Many regulatory frameworks (PCI-DSS, HIPAA, GDPR) require encryption at rest for sensitive data.\n\n**Attack Scenario**: An insider threat with AWS console access creates a snapshot of your unencrypted RDS instance and shares it with an external AWS account they control. They restore the snapshot in their own environment and have complete access to all database contents without needing to crack any encryption. Alternatively, a misconfiguration in snapshot permissions accidentally makes the snapshot public, and automated scanners discover and download it, exposing all customer data stored in the database.","review_questions":["What is the business justification for making the RDS instance publicly accessible? Can the application architecture be modified to place the database in a private subnet?","Why is SSH access (port 22) required from the public internet? Can AWS Systems Manager Session Manager or a bastion host in a restricted IP range be used instead?","What type of data will be stored in the S3 bucket with public-read ACL? Is public access actually required, or should this use CloudFront with signed URLs or bucket policies with specific principals?","What specific AWS services and actions does the Lambda function actually need? Can the wildcard IAM policy be scoped to specific services (e.g., s3:GetObject, dynamodb:PutItem) and resource ARNs?","Why is the CloudTrail being removed? Is there a replacement logging solution, or is this an accidental deletion? What is the impact on compliance requirements?","Is the RDS instance intended for production use? The tags indicate 'production' but multi_az is false, which means no high availability. Should this be enabled?","What is the data classification for information that will be stored in the unencrypted RDS instance? Does this violate any compliance requirements (PCI-DSS, HIPAA, SOC 2)?","Are there existing security group rules or network ACLs that might further restrict access to these resources, or are these the only controls?","Has the security team approved these changes? Given the multiple critical findings, this should go through a security review before deployment.","What is the rollback plan if these changes cause issues? Particularly for the CloudTrail deletion, can it be quickly restored with the same configuration?"]},"pr_comment":"## üîç Terraform Plan Analysis\n\n### Summary\n- **Total Changes**: 5\n- Creates: 4, Updates: 0, Deletes: 1, Replaces: 0\n\n### Security Findings\n- üî¥ **Critical**: 5\n- üü† **High**: 1\n- üü° **Medium**: 0\n- üîµ **Low**: 0\n\n### Executive Summary\n\n- This plan creates 4 new resources and deletes 1 existing resource, with multiple CRITICAL security vulnerabilities that require immediate attention before deployment\n- A production database is being exposed to the public internet without encryption, creating significant data breach risk\n- An IAM policy grants unrestricted wildcard permissions (Action: *, Resource: *), violating least privilege principles\n- CloudTrail logging is being removed, eliminating audit trails required for security monitoring and compliance\n- Public access is being granted through both security group rules (SSH on port 22) and S3 bucket ACLs\n\n### Top Risks\n\n### Security group allows public internet ingress\n\n**Risk**: The security group being created allows inbound traffic from 0.0.0.0/0 (the entire internet) on ports 22 (SSH), 80 (HTTP), and 443 (HTTPS).\n\n**Why This Matters**: Exposing SSH to the public internet is a critical security vulnerability. Port 22 is constantly scanned and targeted by automated attacks attempting credential brute-forcing, exploitation of SSH vulnerabilities, and unauthorized access. Even with strong authentication, this creates an unnecessary attack surface. For production environments, administrative access should never be directly exposed to the internet.\n\n**Attack Scenario**: An attacker runs automated port scans identifying your SSH service on port 22. They launch a credential stuffing attack using leaked password databases or attempt to exploit known SSH vulnerabilities. If successful, they gain shell access to your web servers, can pivot to internal resources, exfiltrate data, install malware, or use your infrastructure for cryptocurrency mining or launching attacks against other targets.\n\n---\n\n### RDS instance is publicly accessible\n\n**Risk**: The RDS database instance has `publicly_accessible` set to `true`, meaning it will receive a public IP address and can be reached from the internet.\n\n**Why This Matters**: Databases contain sensitive application data and should never be directly accessible from the internet. Even with security group restrictions, a publicly accessible database has a routable IP address that can be discovered and targeted. This violates defense-in-depth principles and significantly increases the blast radius if credentials are compromised through application vulnerabilities, phishing, or insider threats.\n\n**Attack Scenario**: An attacker discovers your RDS endpoint through DNS enumeration or leaked configuration files. They exploit a SQL injection vulnerability in your application to extract database credentials, or use credentials exposed in a public GitHub repository. With the database publicly accessible, they connect directly from anywhere in the world, bypassing application-layer controls, and exfiltrate customer data, financial records, or personally identifiable information (PII), leading to regulatory fines, lawsuits, and reputational damage.\n\n---\n\n### S3 bucket ACL allows public access\n\n**Risk**: The S3 bucket is being created with ACL set to `public-read`, allowing anyone on the internet to list and download objects in the bucket.\n\n**Why This Matters**: Public S3 buckets are a leading cause of data breaches. The `public-read` ACL grants unauthenticated read access to all objects, meaning sensitive data stored in this bucket is immediately exposed. This is particularly dangerous for a bucket tagged as production and named for application data. Automated scanners continuously search for publicly accessible S3 buckets.\n\n**Attack Scenario**: An attacker uses automated tools to enumerate S3 bucket names and discovers your publicly readable bucket. They download all contents, which may include customer data, API keys, database backups, or proprietary business information. This data is then sold on dark web forums, used for identity theft, or leveraged for targeted phishing campaigns against your customers. The breach becomes public, triggering GDPR/CCPA violations with fines up to 4% of annual revenue.\n\n---\n\n### IAM policy contains wildcard permissions\n\n**Risk**: The IAM role policy being created grants `Action: *` and `Resource: *`, providing unrestricted access to all AWS services and resources in the account.\n\n**Why This Matters**: This is effectively administrative access without the controls typically applied to admin roles. If the Lambda function using this role is compromised through code vulnerabilities, dependency exploits, or supply chain attacks, the attacker inherits full AWS account control. This violates the principle of least privilege and creates a single point of catastrophic failure.\n\n**Attack Scenario**: A developer introduces a vulnerable dependency in the Lambda function code that allows remote code execution. An attacker exploits this vulnerability and gains control of the Lambda execution environment. With the wildcard IAM permissions, they use the AWS SDK to create new admin users, disable CloudTrail logging, exfiltrate data from all S3 buckets, launch cryptocurrency mining instances across all regions, modify security groups to open backdoors, and establish persistence mechanisms. The blast radius is your entire AWS account.\n\n---\n\n### CloudTrail logging removed\n\n**Risk**: The plan deletes an existing CloudTrail configuration that was providing multi-region audit logging.\n\n**Why This Matters**: CloudTrail is your security camera system for AWS. It records all API calls, providing the audit trail necessary for security investigations, compliance requirements (SOC 2, PCI-DSS, HIPAA), and detecting unauthorized access. Removing CloudTrail eliminates your ability to detect breaches, investigate incidents, or prove compliance. This is often one of the first actions attackers take after compromising an account to hide their activities.\n\n**Attack Scenario**: After removing CloudTrail, an attacker compromises an IAM credential through phishing. They access your AWS account and begin exfiltrating data, creating backdoor access, and modifying resources. Without CloudTrail logs, your security team has no visibility into these actions. The breach continues undetected for months. When finally discovered through customer complaints, you have no forensic evidence to determine what was accessed, when the breach started, or how to fully remediate. Compliance auditors fail your certification, and you cannot provide required breach notifications with accurate scope.\n\n---\n\n### RDS instance storage encryption disabled\n\n**Risk**: The RDS database instance has `storage_encrypted` set to `false`, meaning data at rest is stored unencrypted.\n\n**Why This Matters**: Unencrypted database storage violates data protection best practices and compliance requirements. If the underlying storage is compromised, accessed by unauthorized AWS personnel, or if snapshots are accidentally exposed, the data is readable without additional decryption steps. Many regulatory frameworks (PCI-DSS, HIPAA, GDPR) require encryption at rest for sensitive data.\n\n**Attack Scenario**: An insider threat with AWS console access creates a snapshot of your unencrypted RDS instance and shares it with an external AWS account they control. They restore the snapshot in their own environment and have complete access to all database contents without needing to crack any encryption. Alternatively, a misconfiguration in snapshot permissions accidentally makes the snapshot public, and automated scanners discover and download it, exposing all customer data stored in the database.\n\n### Review Checklist\n\n- [ ] What is the business justification for making the RDS instance publicly accessible? Can the application architecture be modified to place the database in a private subnet?\n- [ ] Why is SSH access (port 22) required from the public internet? Can AWS Systems Manager Session Manager or a bastion host in a restricted IP range be used instead?\n- [ ] What type of data will be stored in the S3 bucket with public-read ACL? Is public access actually required, or should this use CloudFront with signed URLs or bucket policies with specific principals?\n- [ ] What specific AWS services and actions does the Lambda function actually need? Can the wildcard IAM policy be scoped to specific services (e.g., s3:GetObject, dynamodb:PutItem) and resource ARNs?\n- [ ] Why is the CloudTrail being removed? Is there a replacement logging solution, or is this an accidental deletion? What is the impact on compliance requirements?\n- [ ] Is the RDS instance intended for production use? The tags indicate 'production' but multi_az is false, which means no high availability. Should this be enabled?\n- [ ] What is the data classification for information that will be stored in the unencrypted RDS instance? Does this violate any compliance requirements (PCI-DSS, HIPAA, SOC 2)?\n- [ ] Are there existing security group rules or network ACLs that might further restrict access to these resources, or are these the only controls?\n- [ ] Has the security team approved these changes? Given the multiple critical findings, this should go through a security review before deployment.\n- [ ] What is the rollback plan if these changes cause issues? Particularly for the CloudTrail deletion, can it be quickly restored with the same configuration?\n\n---\n_Generated by Terraform Plan Analyzer_","session_id":"d2b4022c-4906-4f4e-b5a3-fd16065b14d4","cached":true,"plan_hash":"acde6b0c1f9dc63f9286291000490a1854c7d2f1cec338634471b086a4c3ed4b"}