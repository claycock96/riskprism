{
  "summary": {
    "total_changes": 5,
    "creates": 4,
    "updates": 0,
    "deletes": 1,
    "replaces": 0,
    "terraform_version": "1.5.0"
  },
  "diff_skeleton": [
    {
      "resource_type": "aws_security_group",
      "action": "create",
      "changed_paths": [
        "description",
        "egress",
        "ingress",
        "name",
        "tags",
        "vpc_id"
      ],
      "resource_id_hash": "res_22acec59da"
    },
    {
      "resource_type": "aws_db_instance",
      "action": "create",
      "changed_paths": [
        "allocated_storage",
        "backup_retention_period",
        "db_name",
        "engine",
        "engine_version",
        "instance_class",
        "multi_az",
        "publicly_accessible",
        "storage_encrypted",
        "tags",
        "username"
      ],
      "resource_id_hash": "res_9468970500"
    },
    {
      "resource_type": "aws_s3_bucket",
      "action": "create",
      "changed_paths": [
        "acl",
        "bucket",
        "tags"
      ],
      "resource_id_hash": "res_06e953a89c"
    },
    {
      "resource_type": "aws_iam_role_policy",
      "action": "create",
      "changed_paths": [
        "name",
        "policy",
        "role"
      ],
      "resource_id_hash": "res_3589369b5b"
    },
    {
      "resource_type": "aws_cloudtrail",
      "action": "delete",
      "changed_paths": [
        "enable_logging",
        "is_multi_region_trail",
        "name",
        "s3_bucket_name"
      ],
      "resource_id_hash": "res_a02da504df"
    }
  ],
  "risk_findings": [
    {
      "risk_id": "SG-OPEN-INGRESS",
      "title": "Security group allows public internet ingress",
      "severity": "critical",
      "resource_type": "aws_security_group",
      "resource_ref": "res_22acec59da",
      "evidence": {
        "public_cidr": true,
        "exposed_ports": [
          22,
          80,
          443
        ],
        "critical_port_exposed": true
      },
      "recommendation": "Restrict CIDR blocks to known IP ranges. For SSH/RDP, use AWS Systems Manager Session Manager or a bastion host. For databases, ensure they are in private subnets with security groups allowing only application tier access.",
      "changed_paths": null
    },
    {
      "risk_id": "RDS-PUBLICLY-ACCESSIBLE",
      "title": "RDS instance is publicly accessible",
      "severity": "critical",
      "resource_type": "aws_db_instance",
      "resource_ref": "res_9468970500",
      "evidence": {
        "publicly_accessible": true
      },
      "recommendation": "Set publicly_accessible to false. Place RDS in private subnets. Use VPC security groups to restrict access to application tier only.",
      "changed_paths": null
    },
    {
      "risk_id": "S3-PUBLIC-ACL-OR-POLICY",
      "title": "S3 bucket ACL allows public access",
      "severity": "critical",
      "resource_type": "aws_s3_bucket",
      "resource_ref": "res_06e953a89c",
      "evidence": {
        "public_acl": "public-read",
        "public_write": false
      },
      "recommendation": "Change ACL to 'private'. Enable S3 Block Public Access. Use bucket policies with specific principals for controlled sharing.",
      "changed_paths": null
    },
    {
      "risk_id": "IAM-ADMIN-WILDCARD",
      "title": "IAM policy contains wildcard permissions",
      "severity": "critical",
      "resource_type": "aws_iam_role_policy",
      "resource_ref": "res_3589369b5b",
      "evidence": {
        "action_wildcard": true,
        "admin_risk": true
      },
      "recommendation": "Scope IAM actions and resources to least privilege. Avoid Action: '*' and Resource: '*'. Use separate break-glass admin roles with MFA and monitoring.",
      "changed_paths": null
    },
    {
      "risk_id": "CT-LOGGING-DISABLED",
      "title": "CloudTrail logging removed",
      "severity": "critical",
      "resource_type": "aws_cloudtrail",
      "resource_ref": "res_a02da504df",
      "evidence": {
        "cloudtrail_removed": true
      },
      "recommendation": "Maintain CloudTrail logging for audit and compliance. Use organization trails for multi-account coverage.",
      "changed_paths": null
    },
    {
      "risk_id": "RDS-ENCRYPTION-OFF",
      "title": "RDS instance storage encryption disabled",
      "severity": "high",
      "resource_type": "aws_db_instance",
      "resource_ref": "res_9468970500",
      "evidence": {
        "encryption_disabled": true
      },
      "recommendation": "Enable storage_encrypted. Note: existing instances require snapshot, restore to new encrypted instance. Plan for maintenance window.",
      "changed_paths": null
    }
  ],
  "explanation": {
    "executive_summary": [
      "This plan contains 5 CRITICAL security findings that require immediate attention before deployment",
      "Creating publicly accessible infrastructure: RDS database exposed to internet, S3 bucket with public-read ACL, and security group allowing SSH from 0.0.0.0/0",
      "IAM role policy grants wildcard (*) permissions creating potential for privilege escalation",
      "CloudTrail audit logging is being DELETED, eliminating visibility into AWS API activity",
      "RDS encryption is disabled, exposing database storage to compliance and data protection risks"
    ],
    "plain_english_changes": "**CREATES (4 resources):**\n\n- **1 Security Group**: New security group with ingress and egress rules, VPC association, and tags\n- **1 RDS Database Instance**: New database with configuration for storage allocation, backup retention, engine settings, instance class, multi-AZ settings, public accessibility, encryption settings, and credentials\n- **1 S3 Bucket**: New bucket with ACL configuration and tags\n- **1 IAM Role Policy**: New inline policy attached to an IAM role with policy document and naming\n\n**DELETES (1 resource):**\n\n- **1 CloudTrail**: Removing existing CloudTrail configuration including logging status, multi-region settings, and S3 bucket association\n\n**UPDATES (0 resources):**\n\nNo resources are being modified in place.\n\n**REPLACES (0 resources):**\n\nNo resources require replacement.",
    "top_risks_explained": "## CRITICAL RISKS\n\n### 1. Security Group Allows Unrestricted Public Internet Access (res_22acec59da)\n**Risk**: The security group being created allows ingress from 0.0.0.0/0 (the entire internet) on ports 22, 80, and 443. Port 22 (SSH) exposure is particularly dangerous as it provides direct administrative access to instances.\n\n**Security Implications**: \n- Exposes resources to brute force attacks, vulnerability scanning, and exploitation attempts from any IP address globally\n- SSH access from the internet violates AWS Well-Architected Framework security pillar\n- Creates attack surface for credential stuffing, zero-day exploits, and automated bot attacks\n- May violate compliance frameworks (PCI-DSS, HIPAA, SOC 2) that require network segmentation\n\n**Business Impact**: Potential for unauthorized access, data breaches, ransomware deployment, and compliance violations.\n\n---\n\n### 2. RDS Database Instance Publicly Accessible (res_9468970500)\n**Risk**: The database instance has `publicly_accessible` set to true, meaning it will receive a public IP address and can be reached from the internet.\n\n**Security Implications**:\n- Database credentials become the only defense layer against unauthorized access\n- Exposes database to credential brute-forcing, SQL injection attempts, and known database engine vulnerabilities\n- Violates defense-in-depth principles by removing network isolation\n- Creates compliance violations for most data protection regulations (GDPR, HIPAA, PCI-DSS)\n- Even with security groups, public accessibility increases attack surface unnecessarily\n\n**Business Impact**: Direct path to sensitive data exfiltration, data manipulation, or complete database compromise.\n\n---\n\n### 3. S3 Bucket with Public-Read ACL (res_06e953a89c)\n**Risk**: The S3 bucket is configured with a 'public-read' ACL, allowing anyone on the internet to list and download bucket contents.\n\n**Security Implications**:\n- All objects in the bucket are readable by unauthenticated users unless explicitly overridden\n- Potential exposure of sensitive data, credentials, configuration files, or proprietary information\n- Creates data leak vector that may go undetected without proper monitoring\n- Violates AWS security best practices and S3 Block Public Access recommendations\n- May trigger compliance violations and regulatory penalties\n\n**Business Impact**: Data breaches, intellectual property theft, credential exposure, reputational damage, and potential regulatory fines.\n\n---\n\n### 4. IAM Role Policy with Wildcard Permissions (res_3589369b5b)\n**Risk**: The IAM role policy contains wildcard actions (Action: \"*\") granting administrative permissions, potentially on all resources.\n\n**Security Implications**:\n- Violates principle of least privilege by granting more permissions than necessary\n- Any service or user assuming this role gains full AWS account control\n- Creates privilege escalation risk if the role is compromised\n- Difficult to audit what actions are actually being performed\n- May allow lateral movement across AWS services during a security incident\n- Increases blast radius of credential compromise or insider threats\n\n**Business Impact**: Complete account takeover potential, unauthorized resource creation/deletion, data exfiltration across all services, and massive cost implications.\n\n---\n\n### 5. CloudTrail Deletion Removes Audit Logging (res_a02da504df)\n**Risk**: Deleting the CloudTrail removes all AWS API activity logging, eliminating audit trails and security monitoring capabilities.\n\n**Security Implications**:\n- Loss of visibility into who did what, when, and from where in your AWS account\n- Inability to detect unauthorized access, privilege escalation, or data exfiltration\n- Compliance violations for frameworks requiring audit logs (SOC 2, ISO 27001, PCI-DSS, HIPAA)\n- Forensic investigation becomes impossible in case of security incidents\n- Security tools relying on CloudTrail (SIEM, CSPM, threat detection) will stop functioning\n- Often a precursor to malicious activity as attackers disable logging before attacks\n\n**Business Impact**: Compliance failures, inability to investigate security incidents, regulatory penalties, and loss of security monitoring.\n\n---\n\n## HIGH RISK\n\n### 6. RDS Storage Encryption Disabled (res_9468970500)\n**Risk**: The RDS instance has `storage_encrypted` set to false or not configured, leaving database storage unencrypted at rest.\n\n**Security Implications**:\n- Data stored on EBS volumes is readable if physical storage is compromised\n- Automated backups and snapshots are also unencrypted\n- Violates compliance requirements for data protection (PCI-DSS, HIPAA, GDPR)\n- No protection against insider threats with infrastructure access\n- Snapshots shared or made public would expose data in plaintext\n\n**Business Impact**: Compliance violations, data exposure through backups/snapshots, and inability to meet contractual data protection obligations. Note that enabling encryption later requires database recreation with downtime.",
    "review_questions": [
      "What is the business justification for making the RDS instance publicly accessible? Can this database be placed in a private subnet with access only from application tier security groups?",
      "What specific IP ranges should have SSH access (port 22) to resources in this security group? Can SSH access be removed entirely in favor of AWS Systems Manager Session Manager?",
      "What data will be stored in the S3 bucket with public-read ACL? Is public access actually required, or can this be changed to 'private' with CloudFront or signed URLs for controlled sharing?",
      "Which IAM principal (user, service, or application) will assume the role with wildcard permissions? What specific AWS actions does this workload actually need to perform?",
      "Why is the CloudTrail being deleted? Is there a replacement logging solution, or is this an oversight? Who approved the removal of audit logging?",
      "Has the security team reviewed and approved these configurations? Are there compensating controls in place for the public accessibility?",
      "What is the data classification of information that will be stored in the RDS instance? Does it contain PII, PHI, payment card data, or other regulated information?",
      "Are there network ACLs, WAF rules, or other defense-in-depth controls that mitigate the security group's open ingress rules?",
      "What is the blast radius if the IAM role with wildcard permissions is compromised? Which services and resources could be affected?",
      "Is S3 Block Public Access enabled at the account level? If not, should it be enabled to prevent accidental public exposure?",
      "For the RDS instance: What is the maintenance window for enabling encryption? Has the team planned for the snapshot-restore process required to encrypt an existing database?",
      "Are there any dependencies on the CloudTrail being deleted? Will this break security monitoring, compliance reporting, or incident response capabilities?",
      "Have you verified that ports 80 and 443 in the security group are intended for legitimate web traffic and not exposing administrative interfaces?",
      "What monitoring and alerting is in place to detect unauthorized access attempts to these publicly accessible resources?"
    ]
  },
  "pr_comment": "## üîç Terraform Plan Analysis\n\n### Summary\n- **Total Changes**: 5\n- Creates: 4, Updates: 0, Deletes: 1, Replaces: 0\n\n### Security Findings\n- üî¥ **Critical**: 5\n- üü† **High**: 1\n- üü° **Medium**: 0\n- üîµ **Low**: 0\n\n### Executive Summary\n\n- This plan contains 5 CRITICAL security findings that require immediate attention before deployment\n- Creating publicly accessible infrastructure: RDS database exposed to internet, S3 bucket with public-read ACL, and security group allowing SSH from 0.0.0.0/0\n- IAM role policy grants wildcard (*) permissions creating potential for privilege escalation\n- CloudTrail audit logging is being DELETED, eliminating visibility into AWS API activity\n- RDS encryption is disabled, exposing database storage to compliance and data protection risks\n\n### Top Risks\n\n## CRITICAL RISKS\n\n### 1. Security Group Allows Unrestricted Public Internet Access (res_22acec59da)\n**Risk**: The security group being created allows ingress from 0.0.0.0/0 (the entire internet) on ports 22, 80, and 443. Port 22 (SSH) exposure is particularly dangerous as it provides direct administrative access to instances.\n\n**Security Implications**: \n- Exposes resources to brute force attacks, vulnerability scanning, and exploitation attempts from any IP address globally\n- SSH access from the internet violates AWS Well-Architected Framework security pillar\n- Creates attack surface for credential stuffing, zero-day exploits, and automated bot attacks\n- May violate compliance frameworks (PCI-DSS, HIPAA, SOC 2) that require network segmentation\n\n**Business Impact**: Potential for unauthorized access, data breaches, ransomware deployment, and compliance violations.\n\n---\n\n### 2. RDS Database Instance Publicly Accessible (res_9468970500)\n**Risk**: The database instance has `publicly_accessible` set to true, meaning it will receive a public IP address and can be reached from the internet.\n\n**Security Implications**:\n- Database credentials become the only defense layer against unauthorized access\n- Exposes database to credential brute-forcing, SQL injection attempts, and known database engine vulnerabilities\n- Violates defense-in-depth principles by removing network isolation\n- Creates compliance violations for most data protection regulations (GDPR, HIPAA, PCI-DSS)\n- Even with security groups, public accessibility increases attack surface unnecessarily\n\n**Business Impact**: Direct path to sensitive data exfiltration, data manipulation, or complete database compromise.\n\n---\n\n### 3. S3 Bucket with Public-Read ACL (res_06e953a89c)\n**Risk**: The S3 bucket is configured with a 'public-read' ACL, allowing anyone on the internet to list and download bucket contents.\n\n**Security Implications**:\n- All objects in the bucket are readable by unauthenticated users unless explicitly overridden\n- Potential exposure of sensitive data, credentials, configuration files, or proprietary information\n- Creates data leak vector that may go undetected without proper monitoring\n- Violates AWS security best practices and S3 Block Public Access recommendations\n- May trigger compliance violations and regulatory penalties\n\n**Business Impact**: Data breaches, intellectual property theft, credential exposure, reputational damage, and potential regulatory fines.\n\n---\n\n### 4. IAM Role Policy with Wildcard Permissions (res_3589369b5b)\n**Risk**: The IAM role policy contains wildcard actions (Action: \"*\") granting administrative permissions, potentially on all resources.\n\n**Security Implications**:\n- Violates principle of least privilege by granting more permissions than necessary\n- Any service or user assuming this role gains full AWS account control\n- Creates privilege escalation risk if the role is compromised\n- Difficult to audit what actions are actually being performed\n- May allow lateral movement across AWS services during a security incident\n- Increases blast radius of credential compromise or insider threats\n\n**Business Impact**: Complete account takeover potential, unauthorized resource creation/deletion, data exfiltration across all services, and massive cost implications.\n\n---\n\n### 5. CloudTrail Deletion Removes Audit Logging (res_a02da504df)\n**Risk**: Deleting the CloudTrail removes all AWS API activity logging, eliminating audit trails and security monitoring capabilities.\n\n**Security Implications**:\n- Loss of visibility into who did what, when, and from where in your AWS account\n- Inability to detect unauthorized access, privilege escalation, or data exfiltration\n- Compliance violations for frameworks requiring audit logs (SOC 2, ISO 27001, PCI-DSS, HIPAA)\n- Forensic investigation becomes impossible in case of security incidents\n- Security tools relying on CloudTrail (SIEM, CSPM, threat detection) will stop functioning\n- Often a precursor to malicious activity as attackers disable logging before attacks\n\n**Business Impact**: Compliance failures, inability to investigate security incidents, regulatory penalties, and loss of security monitoring.\n\n---\n\n## HIGH RISK\n\n### 6. RDS Storage Encryption Disabled (res_9468970500)\n**Risk**: The RDS instance has `storage_encrypted` set to false or not configured, leaving database storage unencrypted at rest.\n\n**Security Implications**:\n- Data stored on EBS volumes is readable if physical storage is compromised\n- Automated backups and snapshots are also unencrypted\n- Violates compliance requirements for data protection (PCI-DSS, HIPAA, GDPR)\n- No protection against insider threats with infrastructure access\n- Snapshots shared or made public would expose data in plaintext\n\n**Business Impact**: Compliance violations, data exposure through backups/snapshots, and inability to meet contractual data protection obligations. Note that enabling encryption later requires database recreation with downtime.\n\n### Review Checklist\n\n- [ ] What is the business justification for making the RDS instance publicly accessible? Can this database be placed in a private subnet with access only from application tier security groups?\n- [ ] What specific IP ranges should have SSH access (port 22) to resources in this security group? Can SSH access be removed entirely in favor of AWS Systems Manager Session Manager?\n- [ ] What data will be stored in the S3 bucket with public-read ACL? Is public access actually required, or can this be changed to 'private' with CloudFront or signed URLs for controlled sharing?\n- [ ] Which IAM principal (user, service, or application) will assume the role with wildcard permissions? What specific AWS actions does this workload actually need to perform?\n- [ ] Why is the CloudTrail being deleted? Is there a replacement logging solution, or is this an oversight? Who approved the removal of audit logging?\n- [ ] Has the security team reviewed and approved these configurations? Are there compensating controls in place for the public accessibility?\n- [ ] What is the data classification of information that will be stored in the RDS instance? Does it contain PII, PHI, payment card data, or other regulated information?\n- [ ] Are there network ACLs, WAF rules, or other defense-in-depth controls that mitigate the security group's open ingress rules?\n- [ ] What is the blast radius if the IAM role with wildcard permissions is compromised? Which services and resources could be affected?\n- [ ] Is S3 Block Public Access enabled at the account level? If not, should it be enabled to prevent accidental public exposure?\n- [ ] For the RDS instance: What is the maintenance window for enabling encryption? Has the team planned for the snapshot-restore process required to encrypt an existing database?\n- [ ] Are there any dependencies on the CloudTrail being deleted? Will this break security monitoring, compliance reporting, or incident response capabilities?\n- [ ] Have you verified that ports 80 and 443 in the security group are intended for legitimate web traffic and not exposing administrative interfaces?\n- [ ] What monitoring and alerting is in place to detect unauthorized access attempts to these publicly accessible resources?\n\n---\n_Generated by [Terraform Plan Analyzer](https://github.com/yourusername/terraform-plan-analyzer)_"
}
