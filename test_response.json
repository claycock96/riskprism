{
  "summary": {
    "total_changes": 5,
    "creates": 4,
    "updates": 0,
    "deletes": 1,
    "replaces": 0,
    "terraform_version": "1.5.0"
  },
  "diff_skeleton": [
    {
      "resource_type": "aws_security_group",
      "action": "create",
      "changed_paths": [
        "description",
        "egress",
        "ingress",
        "name",
        "tags",
        "vpc_id"
      ],
      "resource_id_hash": "res_22acec59da",
      "resource_address": "aws_security_group.web"
    },
    {
      "resource_type": "aws_db_instance",
      "action": "create",
      "changed_paths": [
        "allocated_storage",
        "backup_retention_period",
        "db_name",
        "engine",
        "engine_version",
        "instance_class",
        "multi_az",
        "publicly_accessible",
        "storage_encrypted",
        "tags",
        "username"
      ],
      "resource_id_hash": "res_9468970500",
      "resource_address": "aws_db_instance.main"
    },
    {
      "resource_type": "aws_s3_bucket",
      "action": "create",
      "changed_paths": [
        "acl",
        "bucket",
        "tags"
      ],
      "resource_id_hash": "res_06e953a89c",
      "resource_address": "aws_s3_bucket.data"
    },
    {
      "resource_type": "aws_iam_role_policy",
      "action": "create",
      "changed_paths": [
        "name",
        "policy",
        "role"
      ],
      "resource_id_hash": "res_3589369b5b",
      "resource_address": "aws_iam_role_policy.lambda_exec"
    },
    {
      "resource_type": "aws_cloudtrail",
      "action": "delete",
      "changed_paths": [
        "enable_logging",
        "is_multi_region_trail",
        "name",
        "s3_bucket_name"
      ],
      "resource_id_hash": "res_a02da504df",
      "resource_address": "aws_cloudtrail.main"
    }
  ],
  "risk_findings": [
    {
      "risk_id": "SG-OPEN-INGRESS",
      "title": "Security group allows public internet ingress",
      "severity": "critical",
      "resource_type": "aws_security_group",
      "resource_ref": "res_22acec59da",
      "evidence": {
        "public_cidr": true,
        "exposed_ports": [
          22,
          80,
          443
        ],
        "critical_port_exposed": true
      },
      "recommendation": "Restrict CIDR blocks to known IP ranges. For SSH/RDP, use AWS Systems Manager Session Manager or a bastion host. For databases, ensure they are in private subnets with security groups allowing only application tier access.",
      "changed_paths": null
    },
    {
      "risk_id": "RDS-PUBLICLY-ACCESSIBLE",
      "title": "RDS instance is publicly accessible",
      "severity": "critical",
      "resource_type": "aws_db_instance",
      "resource_ref": "res_9468970500",
      "evidence": {
        "publicly_accessible": true
      },
      "recommendation": "Set publicly_accessible to false. Place RDS in private subnets. Use VPC security groups to restrict access to application tier only.",
      "changed_paths": null
    },
    {
      "risk_id": "S3-PUBLIC-ACL-OR-POLICY",
      "title": "S3 bucket ACL allows public access",
      "severity": "critical",
      "resource_type": "aws_s3_bucket",
      "resource_ref": "res_06e953a89c",
      "evidence": {
        "public_acl": "public-read",
        "public_write": false
      },
      "recommendation": "Change ACL to 'private'. Enable S3 Block Public Access. Use bucket policies with specific principals for controlled sharing.",
      "changed_paths": null
    },
    {
      "risk_id": "IAM-ADMIN-WILDCARD",
      "title": "IAM policy contains wildcard permissions",
      "severity": "critical",
      "resource_type": "aws_iam_role_policy",
      "resource_ref": "res_3589369b5b",
      "evidence": {
        "action_wildcard": true,
        "admin_risk": true
      },
      "recommendation": "Scope IAM actions and resources to least privilege. Avoid Action: '*' and Resource: '*'. Use separate break-glass admin roles with MFA and monitoring.",
      "changed_paths": null
    },
    {
      "risk_id": "CT-LOGGING-DISABLED",
      "title": "CloudTrail logging removed",
      "severity": "critical",
      "resource_type": "aws_cloudtrail",
      "resource_ref": "res_a02da504df",
      "evidence": {
        "cloudtrail_removed": true
      },
      "recommendation": "Maintain CloudTrail logging for audit and compliance. Use organization trails for multi-account coverage.",
      "changed_paths": null
    },
    {
      "risk_id": "RDS-ENCRYPTION-OFF",
      "title": "RDS instance storage encryption disabled",
      "severity": "high",
      "resource_type": "aws_db_instance",
      "resource_ref": "res_9468970500",
      "evidence": {
        "encryption_disabled": true
      },
      "recommendation": "Enable storage_encrypted. Note: existing instances require snapshot, restore to new encrypted instance. Plan for maintenance window.",
      "changed_paths": null
    }
  ],
  "explanation": {
    "executive_summary": [
      "This plan contains 5 CRITICAL severity security findings that require immediate attention before deployment",
      "A CloudTrail audit logging resource is being deleted, which will eliminate visibility into AWS API activity and compliance evidence",
      "Multiple resources are being created with public internet exposure: a security group allowing SSH/HTTP/HTTPS from 0.0.0.0/0, an RDS database with public accessibility enabled, and an S3 bucket with public-read ACL",
      "An IAM role policy is being created with wildcard permissions (Action: '*'), granting excessive privileges that violate least privilege principles",
      "The RDS instance lacks encryption at rest, exposing sensitive data to compliance and security risks"
    ],
    "plain_english_changes": "**CREATES (4 resources):**\n\n- **1 Security Group** (aws_security_group.web): New security group with ingress and egress rules, tags, and VPC association\n- **1 RDS Database Instance** (aws_db_instance.main): New database with configuration for storage allocation, backup retention, engine settings, instance class, multi-AZ settings, public accessibility, encryption settings, and tags\n- **1 S3 Bucket** (aws_s3_bucket.data): New bucket with ACL configuration and tags\n- **1 IAM Role Policy** (aws_iam_role_policy.lambda_exec): New inline policy attached to a role with policy document and name\n\n**DELETES (1 resource):**\n\n- **1 CloudTrail** (aws_cloudtrail.main): Removing audit trail configuration including logging status, multi-region settings, and S3 bucket association\n\n**No resources are being updated or replaced.**",
    "top_risks_explained": "## CRITICAL RISKS\n\n### 1. CloudTrail Deletion - Loss of Audit Visibility\n**Resource:** aws_cloudtrail.main\n\nDeleting CloudTrail eliminates your ability to track who did what, when, and from where in your AWS account. This creates a blind spot for:\n- Security incident investigation and forensics\n- Compliance requirements (PCI-DSS, HIPAA, SOC 2, etc. require audit logs)\n- Detecting unauthorized access or configuration changes\n- Meeting regulatory retention requirements\n\n**Implication:** Without CloudTrail, you cannot detect or investigate security breaches, and you may be out of compliance with regulatory frameworks.\n\n### 2. Security Group with Public Internet Access to Critical Ports\n**Resource:** aws_security_group.web\n\nThis security group allows ingress from 0.0.0.0/0 (the entire internet) on ports 22 (SSH), 80 (HTTP), and 443 (HTTPS). Port 22 exposure is particularly dangerous as it's the primary administrative access protocol for Linux systems.\n\n**Implication:** Attackers can attempt brute force attacks against SSH, exploit vulnerabilities in web services, or use exposed services as entry points for lateral movement. SSH should never be exposed to the public internet.\n\n### 3. Publicly Accessible RDS Database\n**Resource:** aws_db_instance.main\n\nThe database instance has `publicly_accessible` set to true, meaning it can receive connections from the public internet (if security groups allow). Combined with the security group risks above, this could expose your database directly to attackers.\n\n**Implication:** Databases contain sensitive data and should never be internet-facing. Public accessibility enables:\n- Direct brute force attacks against database credentials\n- Exploitation of database engine vulnerabilities\n- Data exfiltration if credentials are compromised\n- Compliance violations (most frameworks prohibit public database access)\n\n### 4. S3 Bucket with Public Read Access\n**Resource:** aws_s3_bucket.data\n\nThe bucket is configured with a 'public-read' ACL, allowing anyone on the internet to list and download objects from this bucket without authentication.\n\n**Implication:** Any data stored in this bucket is publicly accessible, risking:\n- Exposure of sensitive customer data, credentials, or proprietary information\n- Compliance violations (GDPR, CCPA, HIPAA data exposure)\n- Reputational damage from data leaks\n- Potential legal liability\n\n### 5. IAM Policy with Wildcard Permissions\n**Resource:** aws_iam_role_policy.lambda_exec\n\nThis policy contains wildcard actions (Action: '*'), effectively granting administrative privileges. This violates the principle of least privilege.\n\n**Implication:** If this role is compromised (e.g., through application vulnerability, credential leak, or Lambda function exploit):\n- Attackers gain full control over your AWS account\n- They can create resources, access data, modify security settings, or delete infrastructure\n- Lateral movement becomes trivial\n- Blast radius of any security incident is maximized\n\n## HIGH RISK\n\n### 6. RDS Encryption Disabled\n**Resource:** aws_db_instance.main\n\nThe database instance does not have storage encryption enabled (`storage_encrypted` not set or false).\n\n**Implication:** Data at rest is stored unencrypted, meaning:\n- Compliance violations (many frameworks require encryption at rest)\n- If storage media is compromised or improperly disposed of, data is readable\n- Snapshots and backups are also unencrypted\n- Cannot enable encryption later without recreating the instance (requires downtime)",
    "review_questions": [
      "What is the business justification for deleting the CloudTrail? Is there an organization-level trail that provides coverage, or is audit logging being completely removed?",
      "What resources will use the security group aws_security_group.web? Are these truly public-facing web servers, or should they be behind a load balancer?",
      "Why does SSH (port 22) need to be accessible from the internet? Can AWS Systems Manager Session Manager be used instead for administrative access?",
      "What type of data will be stored in the RDS instance aws_db_instance.main? Does it contain PII, PHI, payment data, or other sensitive information that requires encryption and private access?",
      "What is the intended network architecture? Should the RDS instance be in a private subnet with no internet gateway route, accessible only from application tier security groups?",
      "What data will be stored in the S3 bucket aws_s3_bucket.data? Is public read access intentional (e.g., for static website hosting), or should this be private?",
      "Are S3 Block Public Access settings enabled at the account/bucket level to prevent accidental public exposure?",
      "What Lambda function will use the IAM role policy aws_iam_role_policy.lambda_exec? What specific AWS services and actions does it actually need?",
      "Can the IAM policy be scoped to specific actions (e.g., s3:GetObject, dynamodb:PutItem) and specific resource ARNs instead of wildcards?",
      "Is there a compliance requirement (PCI-DSS, HIPAA, SOC 2, ISO 27001) that mandates encryption at rest for the database?",
      "What is the backup and disaster recovery strategy for the RDS instance? Is the backup_retention_period sufficient for your RPO/RTO requirements?",
      "Are there VPC flow logs, GuardDuty, or Security Hub enabled to compensate for the CloudTrail deletion?",
      "Has this plan been reviewed against your organization's security baseline and AWS Well-Architected Framework security pillar?"
    ]
  },
  "pr_comment": "## üîç Terraform Plan Analysis\n\n### Summary\n- **Total Changes**: 5\n- Creates: 4, Updates: 0, Deletes: 1, Replaces: 0\n\n### Security Findings\n- üî¥ **Critical**: 5\n- üü† **High**: 1\n- üü° **Medium**: 0\n- üîµ **Low**: 0\n\n### Executive Summary\n\n- This plan contains 5 CRITICAL severity security findings that require immediate attention before deployment\n- A CloudTrail audit logging resource is being deleted, which will eliminate visibility into AWS API activity and compliance evidence\n- Multiple resources are being created with public internet exposure: a security group allowing SSH/HTTP/HTTPS from 0.0.0.0/0, an RDS database with public accessibility enabled, and an S3 bucket with public-read ACL\n- An IAM role policy is being created with wildcard permissions (Action: '*'), granting excessive privileges that violate least privilege principles\n- The RDS instance lacks encryption at rest, exposing sensitive data to compliance and security risks\n\n### Top Risks\n\n## CRITICAL RISKS\n\n### 1. CloudTrail Deletion - Loss of Audit Visibility\n**Resource:** aws_cloudtrail.main\n\nDeleting CloudTrail eliminates your ability to track who did what, when, and from where in your AWS account. This creates a blind spot for:\n- Security incident investigation and forensics\n- Compliance requirements (PCI-DSS, HIPAA, SOC 2, etc. require audit logs)\n- Detecting unauthorized access or configuration changes\n- Meeting regulatory retention requirements\n\n**Implication:** Without CloudTrail, you cannot detect or investigate security breaches, and you may be out of compliance with regulatory frameworks.\n\n### 2. Security Group with Public Internet Access to Critical Ports\n**Resource:** aws_security_group.web\n\nThis security group allows ingress from 0.0.0.0/0 (the entire internet) on ports 22 (SSH), 80 (HTTP), and 443 (HTTPS). Port 22 exposure is particularly dangerous as it's the primary administrative access protocol for Linux systems.\n\n**Implication:** Attackers can attempt brute force attacks against SSH, exploit vulnerabilities in web services, or use exposed services as entry points for lateral movement. SSH should never be exposed to the public internet.\n\n### 3. Publicly Accessible RDS Database\n**Resource:** aws_db_instance.main\n\nThe database instance has `publicly_accessible` set to true, meaning it can receive connections from the public internet (if security groups allow). Combined with the security group risks above, this could expose your database directly to attackers.\n\n**Implication:** Databases contain sensitive data and should never be internet-facing. Public accessibility enables:\n- Direct brute force attacks against database credentials\n- Exploitation of database engine vulnerabilities\n- Data exfiltration if credentials are compromised\n- Compliance violations (most frameworks prohibit public database access)\n\n### 4. S3 Bucket with Public Read Access\n**Resource:** aws_s3_bucket.data\n\nThe bucket is configured with a 'public-read' ACL, allowing anyone on the internet to list and download objects from this bucket without authentication.\n\n**Implication:** Any data stored in this bucket is publicly accessible, risking:\n- Exposure of sensitive customer data, credentials, or proprietary information\n- Compliance violations (GDPR, CCPA, HIPAA data exposure)\n- Reputational damage from data leaks\n- Potential legal liability\n\n### 5. IAM Policy with Wildcard Permissions\n**Resource:** aws_iam_role_policy.lambda_exec\n\nThis policy contains wildcard actions (Action: '*'), effectively granting administrative privileges. This violates the principle of least privilege.\n\n**Implication:** If this role is compromised (e.g., through application vulnerability, credential leak, or Lambda function exploit):\n- Attackers gain full control over your AWS account\n- They can create resources, access data, modify security settings, or delete infrastructure\n- Lateral movement becomes trivial\n- Blast radius of any security incident is maximized\n\n## HIGH RISK\n\n### 6. RDS Encryption Disabled\n**Resource:** aws_db_instance.main\n\nThe database instance does not have storage encryption enabled (`storage_encrypted` not set or false).\n\n**Implication:** Data at rest is stored unencrypted, meaning:\n- Compliance violations (many frameworks require encryption at rest)\n- If storage media is compromised or improperly disposed of, data is readable\n- Snapshots and backups are also unencrypted\n- Cannot enable encryption later without recreating the instance (requires downtime)\n\n### Review Checklist\n\n- [ ] What is the business justification for deleting the CloudTrail? Is there an organization-level trail that provides coverage, or is audit logging being completely removed?\n- [ ] What resources will use the security group aws_security_group.web? Are these truly public-facing web servers, or should they be behind a load balancer?\n- [ ] Why does SSH (port 22) need to be accessible from the internet? Can AWS Systems Manager Session Manager be used instead for administrative access?\n- [ ] What type of data will be stored in the RDS instance aws_db_instance.main? Does it contain PII, PHI, payment data, or other sensitive information that requires encryption and private access?\n- [ ] What is the intended network architecture? Should the RDS instance be in a private subnet with no internet gateway route, accessible only from application tier security groups?\n- [ ] What data will be stored in the S3 bucket aws_s3_bucket.data? Is public read access intentional (e.g., for static website hosting), or should this be private?\n- [ ] Are S3 Block Public Access settings enabled at the account/bucket level to prevent accidental public exposure?\n- [ ] What Lambda function will use the IAM role policy aws_iam_role_policy.lambda_exec? What specific AWS services and actions does it actually need?\n- [ ] Can the IAM policy be scoped to specific actions (e.g., s3:GetObject, dynamodb:PutItem) and specific resource ARNs instead of wildcards?\n- [ ] Is there a compliance requirement (PCI-DSS, HIPAA, SOC 2, ISO 27001) that mandates encryption at rest for the database?\n- [ ] What is the backup and disaster recovery strategy for the RDS instance? Is the backup_retention_period sufficient for your RPO/RTO requirements?\n- [ ] Are there VPC flow logs, GuardDuty, or Security Hub enabled to compensate for the CloudTrail deletion?\n- [ ] Has this plan been reviewed against your organization's security baseline and AWS Well-Architected Framework security pillar?\n\n---\n_Generated by Terraform Plan Analyzer_",
  "session_id": "d69b7afd-fcf8-4053-ac7c-eab733a7c712"
}
