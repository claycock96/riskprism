{
  "summary": {
    "total_changes": 5,
    "creates": 4,
    "updates": 0,
    "deletes": 1,
    "replaces": 0,
    "terraform_version": "1.5.0"
  },
  "diff_skeleton": [
    {
      "resource_type": "aws_security_group",
      "action": "create",
      "changed_paths": [
        "description",
        "egress",
        "ingress",
        "name",
        "tags",
        "vpc_id"
      ],
      "resource_id_hash": "res_22acec59da",
      "resource_address": "aws_security_group.web"
    },
    {
      "resource_type": "aws_db_instance",
      "action": "create",
      "changed_paths": [
        "allocated_storage",
        "backup_retention_period",
        "db_name",
        "engine",
        "engine_version",
        "instance_class",
        "multi_az",
        "publicly_accessible",
        "storage_encrypted",
        "tags",
        "username"
      ],
      "resource_id_hash": "res_9468970500",
      "resource_address": "aws_db_instance.main"
    },
    {
      "resource_type": "aws_s3_bucket",
      "action": "create",
      "changed_paths": [
        "acl",
        "bucket",
        "tags"
      ],
      "resource_id_hash": "res_06e953a89c",
      "resource_address": "aws_s3_bucket.data"
    },
    {
      "resource_type": "aws_iam_role_policy",
      "action": "create",
      "changed_paths": [
        "name",
        "policy",
        "role"
      ],
      "resource_id_hash": "res_3589369b5b",
      "resource_address": "aws_iam_role_policy.lambda_exec"
    },
    {
      "resource_type": "aws_cloudtrail",
      "action": "delete",
      "changed_paths": [
        "enable_logging",
        "is_multi_region_trail",
        "name",
        "s3_bucket_name"
      ],
      "resource_id_hash": "res_a02da504df",
      "resource_address": "aws_cloudtrail.main"
    }
  ],
  "risk_findings": [
    {
      "risk_id": "SG-OPEN-INGRESS",
      "title": "Security group allows public internet ingress",
      "severity": "critical",
      "resource_type": "aws_security_group",
      "resource_ref": "res_22acec59da",
      "evidence": {
        "public_cidr": true,
        "exposed_ports": [
          22,
          80,
          443
        ],
        "critical_port_exposed": true
      },
      "recommendation": "Restrict CIDR blocks to known IP ranges. For SSH/RDP, use AWS Systems Manager Session Manager or a bastion host. For databases, ensure they are in private subnets with security groups allowing only application tier access.",
      "changed_paths": null
    },
    {
      "risk_id": "RDS-PUBLICLY-ACCESSIBLE",
      "title": "RDS instance is publicly accessible",
      "severity": "critical",
      "resource_type": "aws_db_instance",
      "resource_ref": "res_9468970500",
      "evidence": {
        "publicly_accessible": true
      },
      "recommendation": "Set publicly_accessible to false. Place RDS in private subnets. Use VPC security groups to restrict access to application tier only.",
      "changed_paths": null
    },
    {
      "risk_id": "S3-PUBLIC-ACL-OR-POLICY",
      "title": "S3 bucket ACL allows public access",
      "severity": "critical",
      "resource_type": "aws_s3_bucket",
      "resource_ref": "res_06e953a89c",
      "evidence": {
        "public_acl": "public-read",
        "public_write": false
      },
      "recommendation": "Change ACL to 'private'. Enable S3 Block Public Access. Use bucket policies with specific principals for controlled sharing.",
      "changed_paths": null
    },
    {
      "risk_id": "IAM-ADMIN-WILDCARD",
      "title": "IAM policy contains wildcard permissions",
      "severity": "critical",
      "resource_type": "aws_iam_role_policy",
      "resource_ref": "res_3589369b5b",
      "evidence": {
        "action_wildcard": true,
        "admin_risk": true
      },
      "recommendation": "Scope IAM actions and resources to least privilege. Avoid Action: '*' and Resource: '*'. Use separate break-glass admin roles with MFA and monitoring.",
      "changed_paths": null
    },
    {
      "risk_id": "CT-LOGGING-DISABLED",
      "title": "CloudTrail logging removed",
      "severity": "critical",
      "resource_type": "aws_cloudtrail",
      "resource_ref": "res_a02da504df",
      "evidence": {
        "cloudtrail_removed": true
      },
      "recommendation": "Maintain CloudTrail logging for audit and compliance. Use organization trails for multi-account coverage.",
      "changed_paths": null
    },
    {
      "risk_id": "RDS-ENCRYPTION-OFF",
      "title": "RDS instance storage encryption disabled",
      "severity": "high",
      "resource_type": "aws_db_instance",
      "resource_ref": "res_9468970500",
      "evidence": {
        "encryption_disabled": true
      },
      "recommendation": "Enable storage_encrypted. Note: existing instances require snapshot, restore to new encrypted instance. Plan for maintenance window.",
      "changed_paths": null
    }
  ],
  "explanation": {
    "executive_summary": [
      "This plan contains 5 CRITICAL and 1 HIGH severity security findings that require immediate attention before applying",
      "CloudTrail logging is being DELETED, which will eliminate audit trails and compliance evidence for all AWS API activity",
      "Multiple resources are being exposed to the public internet: RDS database (publicly_accessible=true), S3 bucket (public-read ACL), and security group allowing SSH/HTTP/HTTPS from 0.0.0.0/0",
      "An IAM role policy is being created with wildcard permissions (Action: '*'), granting excessive privileges that violate least privilege principles",
      "RDS instance is being created without encryption at rest, exposing sensitive data to compliance and security risks"
    ],
    "plain_english_changes": "**CREATES (4 resources):**\n\n- **1 Security Group** (aws_security_group.web): New security group with ingress and egress rules, tags, and VPC association\n\n- **1 RDS Database Instance** (aws_db_instance.main): New database with configuration for storage allocation, backup retention, engine settings, instance class, multi-AZ settings, public accessibility, encryption settings, and credentials\n\n- **1 S3 Bucket** (aws_s3_bucket.data): New bucket with ACL configuration and tags\n\n- **1 IAM Role Policy** (aws_iam_role_policy.lambda_exec): New inline policy attached to a role with policy document and name\n\n**DELETES (1 resource):**\n\n- **1 CloudTrail** (aws_cloudtrail.main): Removing existing CloudTrail configuration including logging status, multi-region settings, and S3 bucket association\n\n**UPDATES (0 resources):** None\n\n**REPLACES (0 resources):** None",
    "top_risks_explained": "## CRITICAL RISKS\n\n**1. CloudTrail Deletion - Audit Blindness (CT-LOGGING-DISABLED)**\n\nDeleting the CloudTrail (aws_cloudtrail.main) will eliminate all AWS API activity logging. This creates a critical security gap:\n- No forensic evidence if a security incident occurs\n- Compliance violations for standards requiring audit trails (PCI-DSS, HIPAA, SOC 2, ISO 27001)\n- No visibility into who made what changes to your AWS environment\n- Inability to detect unauthorized access or configuration changes\n\nCloudTrail is foundational for security monitoring and should never be disabled without an alternative logging solution in place.\n\n**2. Publicly Accessible RDS Database (RDS-PUBLICLY-ACCESSIBLE)**\n\nThe RDS instance (aws_db_instance.main) is configured with publicly_accessible=true, meaning:\n- The database will receive a public IP address accessible from the internet\n- Even with security group restrictions, this expands the attack surface significantly\n- Databases should NEVER be directly accessible from the internet\n- This is a common vector for data breaches and ransomware attacks\n\nCombined with the security group findings below, this could expose your database to brute force attacks, SQL injection attempts, and unauthorized data access.\n\n**3. Security Group Allows Public Internet Access to Critical Ports (SG-OPEN-INGRESS)**\n\nThe security group (aws_security_group.web) allows ingress from 0.0.0.0/0 (entire internet) on ports:\n- **Port 22 (SSH)**: Exposes administrative access to brute force attacks. SSH should only be accessible from known IP ranges or via AWS Systems Manager Session Manager\n- **Ports 80/443 (HTTP/HTTPS)**: May be intentional for web services, but verify this is the intended exposure\n\nPort 22 exposure is particularly dangerous as it provides direct shell access if credentials are compromised. Automated bots constantly scan for open SSH ports.\n\n**4. S3 Bucket with Public Read Access (S3-PUBLIC-ACL-OR-POLICY)**\n\nThe S3 bucket (aws_s3_bucket.data) has ACL set to 'public-read', meaning:\n- Anyone on the internet can list and download all objects in this bucket\n- No authentication required to access data\n- This is a common cause of data breaches and has led to numerous high-profile incidents\n- Even if data seems non-sensitive now, future uploads could expose confidential information\n\nUnless this bucket explicitly hosts a public website, this configuration is almost certainly unintentional and dangerous.\n\n**5. IAM Policy with Wildcard Admin Permissions (IAM-ADMIN-WILDCARD)**\n\nThe IAM role policy (aws_iam_role_policy.lambda_exec) contains Action: '*' wildcards, which:\n- Grants full administrative permissions across all AWS services\n- Violates the principle of least privilege\n- If the associated Lambda function or role is compromised, attackers gain full account control\n- Makes it impossible to audit what permissions are actually needed\n- Increases blast radius of any security incident\n\nLambda functions should have narrowly scoped permissions for only the specific actions and resources they need.\n\n## HIGH RISK\n\n**6. RDS Encryption Disabled (RDS-ENCRYPTION-OFF)**\n\nThe RDS instance (aws_db_instance.main) has storage_encrypted not enabled or set to false:\n- Data at rest is stored unencrypted on EBS volumes\n- Violates compliance requirements for most regulatory frameworks\n- If storage media is compromised or improperly decommissioned, data is readable\n- Cannot be enabled after creation - requires snapshot and restore to a new encrypted instance\n\nWhile not as immediately exploitable as public exposure, this violates data protection best practices and compliance requirements.",
    "review_questions": [
      "What is the business justification for deleting the CloudTrail? Is there an alternative audit logging solution in place, or is this deletion accidental?",
      "Is the RDS database (aws_db_instance.main) intended to be publicly accessible? What type of data will it store, and why can't it be placed in a private subnet?",
      "For the security group (aws_security_group.web): Is SSH access from the entire internet (0.0.0.0/0) truly required? Can this be restricted to specific IP ranges, a VPN, or replaced with AWS Systems Manager Session Manager?",
      "What data will be stored in the S3 bucket (aws_s3_bucket.data)? Is public-read access intentional for hosting a static website, or should this be private?",
      "What specific AWS actions does the Lambda function associated with aws_iam_role_policy.lambda_exec actually need? Can the policy be scoped to specific services and resources instead of using wildcards?",
      "Why is encryption disabled for the RDS instance? Are there performance concerns, or was this an oversight? What is the data classification for the database contents?",
      "Are there any S3 Block Public Access settings configured at the account or bucket level that might override the public-read ACL?",
      "What VPC and subnet is the RDS instance being deployed into? Are there network ACLs or route table configurations that provide additional protection?",
      "Is multi-region CloudTrail coverage required for compliance? What is the retention period for CloudTrail logs?",
      "Have you verified that the security group ingress rules align with your organization's network security policies and any compliance frameworks you must adhere to?",
      "What is the backup and disaster recovery strategy for the RDS instance given the backup_retention_period configuration?",
      "Are there any AWS Config rules, Security Hub controls, or GuardDuty findings that will trigger alerts for these configurations in your environment?"
    ]
  },
  "pr_comment": "## üîç Terraform Plan Analysis\n\n### Summary\n- **Total Changes**: 5\n- Creates: 4, Updates: 0, Deletes: 1, Replaces: 0\n\n### Security Findings\n- üî¥ **Critical**: 5\n- üü† **High**: 1\n- üü° **Medium**: 0\n- üîµ **Low**: 0\n\n### Executive Summary\n\n- This plan contains 5 CRITICAL and 1 HIGH severity security findings that require immediate attention before applying\n- CloudTrail logging is being DELETED, which will eliminate audit trails and compliance evidence for all AWS API activity\n- Multiple resources are being exposed to the public internet: RDS database (publicly_accessible=true), S3 bucket (public-read ACL), and security group allowing SSH/HTTP/HTTPS from 0.0.0.0/0\n- An IAM role policy is being created with wildcard permissions (Action: '*'), granting excessive privileges that violate least privilege principles\n- RDS instance is being created without encryption at rest, exposing sensitive data to compliance and security risks\n\n### Top Risks\n\n## CRITICAL RISKS\n\n**1. CloudTrail Deletion - Audit Blindness (CT-LOGGING-DISABLED)**\n\nDeleting the CloudTrail (aws_cloudtrail.main) will eliminate all AWS API activity logging. This creates a critical security gap:\n- No forensic evidence if a security incident occurs\n- Compliance violations for standards requiring audit trails (PCI-DSS, HIPAA, SOC 2, ISO 27001)\n- No visibility into who made what changes to your AWS environment\n- Inability to detect unauthorized access or configuration changes\n\nCloudTrail is foundational for security monitoring and should never be disabled without an alternative logging solution in place.\n\n**2. Publicly Accessible RDS Database (RDS-PUBLICLY-ACCESSIBLE)**\n\nThe RDS instance (aws_db_instance.main) is configured with publicly_accessible=true, meaning:\n- The database will receive a public IP address accessible from the internet\n- Even with security group restrictions, this expands the attack surface significantly\n- Databases should NEVER be directly accessible from the internet\n- This is a common vector for data breaches and ransomware attacks\n\nCombined with the security group findings below, this could expose your database to brute force attacks, SQL injection attempts, and unauthorized data access.\n\n**3. Security Group Allows Public Internet Access to Critical Ports (SG-OPEN-INGRESS)**\n\nThe security group (aws_security_group.web) allows ingress from 0.0.0.0/0 (entire internet) on ports:\n- **Port 22 (SSH)**: Exposes administrative access to brute force attacks. SSH should only be accessible from known IP ranges or via AWS Systems Manager Session Manager\n- **Ports 80/443 (HTTP/HTTPS)**: May be intentional for web services, but verify this is the intended exposure\n\nPort 22 exposure is particularly dangerous as it provides direct shell access if credentials are compromised. Automated bots constantly scan for open SSH ports.\n\n**4. S3 Bucket with Public Read Access (S3-PUBLIC-ACL-OR-POLICY)**\n\nThe S3 bucket (aws_s3_bucket.data) has ACL set to 'public-read', meaning:\n- Anyone on the internet can list and download all objects in this bucket\n- No authentication required to access data\n- This is a common cause of data breaches and has led to numerous high-profile incidents\n- Even if data seems non-sensitive now, future uploads could expose confidential information\n\nUnless this bucket explicitly hosts a public website, this configuration is almost certainly unintentional and dangerous.\n\n**5. IAM Policy with Wildcard Admin Permissions (IAM-ADMIN-WILDCARD)**\n\nThe IAM role policy (aws_iam_role_policy.lambda_exec) contains Action: '*' wildcards, which:\n- Grants full administrative permissions across all AWS services\n- Violates the principle of least privilege\n- If the associated Lambda function or role is compromised, attackers gain full account control\n- Makes it impossible to audit what permissions are actually needed\n- Increases blast radius of any security incident\n\nLambda functions should have narrowly scoped permissions for only the specific actions and resources they need.\n\n## HIGH RISK\n\n**6. RDS Encryption Disabled (RDS-ENCRYPTION-OFF)**\n\nThe RDS instance (aws_db_instance.main) has storage_encrypted not enabled or set to false:\n- Data at rest is stored unencrypted on EBS volumes\n- Violates compliance requirements for most regulatory frameworks\n- If storage media is compromised or improperly decommissioned, data is readable\n- Cannot be enabled after creation - requires snapshot and restore to a new encrypted instance\n\nWhile not as immediately exploitable as public exposure, this violates data protection best practices and compliance requirements.\n\n### Review Checklist\n\n- [ ] What is the business justification for deleting the CloudTrail? Is there an alternative audit logging solution in place, or is this deletion accidental?\n- [ ] Is the RDS database (aws_db_instance.main) intended to be publicly accessible? What type of data will it store, and why can't it be placed in a private subnet?\n- [ ] For the security group (aws_security_group.web): Is SSH access from the entire internet (0.0.0.0/0) truly required? Can this be restricted to specific IP ranges, a VPN, or replaced with AWS Systems Manager Session Manager?\n- [ ] What data will be stored in the S3 bucket (aws_s3_bucket.data)? Is public-read access intentional for hosting a static website, or should this be private?\n- [ ] What specific AWS actions does the Lambda function associated with aws_iam_role_policy.lambda_exec actually need? Can the policy be scoped to specific services and resources instead of using wildcards?\n- [ ] Why is encryption disabled for the RDS instance? Are there performance concerns, or was this an oversight? What is the data classification for the database contents?\n- [ ] Are there any S3 Block Public Access settings configured at the account or bucket level that might override the public-read ACL?\n- [ ] What VPC and subnet is the RDS instance being deployed into? Are there network ACLs or route table configurations that provide additional protection?\n- [ ] Is multi-region CloudTrail coverage required for compliance? What is the retention period for CloudTrail logs?\n- [ ] Have you verified that the security group ingress rules align with your organization's network security policies and any compliance frameworks you must adhere to?\n- [ ] What is the backup and disaster recovery strategy for the RDS instance given the backup_retention_period configuration?\n- [ ] Are there any AWS Config rules, Security Hub controls, or GuardDuty findings that will trigger alerts for these configurations in your environment?\n\n---\n_Generated by Terraform Plan Analyzer_",
  "session_id": "ba39158a-159d-4423-a29e-7d696939e9b4"
}
